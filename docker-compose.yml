version: "3.9"

services:
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx
    restart: unless-stopped
    # NOTE: network_mode: host does NOT work on Docker Desktop (macOS/Windows).
    # Use bridge mode with port mappings instead.
    # On Linux production servers, you can switch to network_mode: host for WebRTC.
    # network_mode: host
    ports:
      - "${RTSP_PORT:-8554}:8554"       # RTSP
      - "${HLS_PORT:-8888}:8888"        # HLS
      - "${WEBRTC_PORT:-8889}:8889"     # WebRTC HTTP signaling
      - "8189:8189/udp"                 # WebRTC ICE/UDP
      - "${API_PORT:-9997}:9997"        # Control API
      - "9998:9998"                     # Metrics
      - "1935:1935"                     # RTMP
      - "8890:8890/udp"                 # SRT
    volumes:
      - ./mediamtx.yml:/mediamtx.yml:ro
      - ./recordings:/recordings
    environment:
      - MTX_LOGLEVEL=info
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:${API_PORT:-9997}/v3/paths/list"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
